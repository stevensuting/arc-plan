(function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)})(function(a){function b(a,b){this.cm=a,this.options=this.buildOptions(b),this.widget=null,this.tick=this.debounce=0,this.startPos=this.cm.getCursor(),this.startLen=this.cm.getLine(this.startPos.line).length;var c=this;a.on("cursorActivity",this.activityFunc=function(){c.cursorActivity()})}function c(a,b){function c(a,c){var e;e="string"!=typeof c?function(a){return c(a,b)}:d.hasOwnProperty(c)?d[c]:c,f[a]=e}var d={Up:function(){b.moveFocus(-1)},Down:function(){b.moveFocus(1)},PageUp:function(){b.moveFocus(-b.menuSize()+1,!0)},PageDown:function(){b.moveFocus(b.menuSize()-1,!0)},Home:function(){b.setFocus(0)},End:function(){b.setFocus(b.length-1)},Enter:b.pick,Tab:b.pick,Esc:b.close},e=a.options.customKeys,f=e?{}:d;if(e)for(var g in e)e.hasOwnProperty(g)&&c(g,e[g]);if(e=a.options.extraKeys)for(g in e)e.hasOwnProperty(g)&&c(g,e[g]);return f}function d(a,b){for(;b&&b!=a;){if("LI"===b.nodeName.toUpperCase()&&b.parentNode==a)return b;b=b.parentNode}}function e(b,e){this.completion=b,this.data=e,this.picked=!1;var f=this,g=b.cm,h=this.hints=document.createElement("ul");h.className="CodeMirror-hints",this.selectedHint=e.selectedHint||0;for(var i=e.list,j=0;j<i.length;++j){var k=h.appendChild(document.createElement("li")),l=i[j],m="CodeMirror-hint"+(j!=this.selectedHint?"":" CodeMirror-hint-active");null!=l.className&&(m=l.className+" "+m),k.className=m,l.render?l.render(k,e,l):k.appendChild(document.createTextNode(l.displayText||("string"==typeof l?l:l.text))),k.hintId=j}var j=g.cursorCoords(b.options.alignWithWord?e.from:null),n=j.left,o=j.bottom,p=!0;h.style.left=n+"px",h.style.top=o+"px",k=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),m=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight),(b.options.container||document.body).appendChild(h),l=h.getBoundingClientRect();if(0<l.bottom-m){var q=l.bottom-l.top;0<j.top-(j.bottom-l.top)-q?(h.style.top=(o=j.top-q)+"px",p=!1):q>m&&(h.style.height=m-5+"px",h.style.top=(o=j.bottom-l.top)+"px",m=g.getCursor(),e.from.ch!=m.ch&&(j=g.cursorCoords(m),h.style.left=(n=j.left)+"px",l=h.getBoundingClientRect()))}m=l.right-k,0<m&&(l.right-l.left>k&&(h.style.width=k-5+"px",m-=l.right-l.left-k),h.style.left=(n=j.left-m)+"px"),g.addKeyMap(this.keyMap=c(b,{moveFocus:function(a,b){f.changeActive(f.selectedHint+a,b)},setFocus:function(a){f.changeActive(a)},menuSize:function(){return f.screenAmount()},length:i.length,close:function(){b.close()},pick:function(){f.pick()},data:e}));if(b.options.closeOnUnfocus){var r;g.on("blur",this.onBlur=function(){r=setTimeout(function(){b.close()},100)}),g.on("focus",this.onFocus=function(){clearTimeout(r)})}var s=g.getScrollInfo();return g.on("scroll",this.onScroll=function(){var a=g.getScrollInfo(),c=g.getWrapperElement().getBoundingClientRect(),d=o+s.top-a.top,e=d-(window.pageYOffset||(document.documentElement||document.body).scrollTop);p||(e+=h.offsetHeight);if(e<=c.top||e>=c.bottom)return b.close();h.style.top=d+"px",h.style.left=n+s.left-a.left+"px"}),a.on(h,"dblclick",function(a){(a=d(h,a.target||a.srcElement))&&null!=a.hintId&&(f.changeActive(a.hintId),f.pick())}),a.on(h,"click",function(a){(a=d(h,a.target||a.srcElement))&&null!=a.hintId&&(f.changeActive(a.hintId),b.options.completeOnSingleClick&&f.pick())}),a.on(h,"mousedown",function(){setTimeout(function(){g.focus()},20)}),a.signal(e,"select",i[0],h.firstChild),!0}a.showHint=function(a,b,c){if(!b)return a.showHint(c);c&&c.async&&(b.async=!0),b={hint:b};if(c)for(var d in c)b[d]=c[d];return a.showHint(b)},a.defineExtension("showHint",function(c){1<this.listSelections().length||this.somethingSelected()||(this.state.completionActive&&this.state.completionActive.close(),c=this.state.completionActive=new b(this,c),c.options.hint&&(a.signal(this,"startCompletion",this),c.update()))});var f=window.requestAnimationFrame||function(a){return setTimeout(a,1e3/60)},g=window.cancelAnimationFrame||clearTimeout;b.prototype={close:function(){this.active()&&(this.tick=this.cm.state.completionActive=null,this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.widget.close(),a.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(b,c){var d=b.list[c];d.hint?d.hint(this.cm,b,d):this.cm.replaceRange("string"==typeof d?d:d.text,d.from||b.from,d.to||b.to,"complete"),a.signal(b,"pick",d),this.close()},showHints:function(a){if(!a||!a.list.length||!this.active())return this.close();this.options.completeSingle&&1==a.list.length?this.pick(a,0):this.showWidget(a)},cursorActivity:function(){this.debounce&&(g(this.debounce),this.debounce=0);var a=this.cm.getCursor(),b=this.cm.getLine(a.line);if(a.line!=this.startPos.line||b.length-a.ch!=this.startLen-this.startPos.ch||a.ch<this.startPos.ch||this.cm.somethingSelected()||a.ch&&this.options.closeCharacters.test(b.charAt(a.ch-1)))this.close();else{var c=this;this.debounce=f(function(){c.update()}),this.widget&&this.widget.disable()}},update:function(){if(null!=this.tick)if(this.data&&a.signal(this.data,"update"),this.options.hint.async){var b=++this.tick,c=this;this.options.hint(this.cm,function(a){c.tick==b&&c.finishUpdate(a)},this.options)}else this.finishUpdate(this.options.hint(this.cm,this.options),b)},finishUpdate:function(a){this.data=a;var b=this.widget&&this.widget.picked;this.widget&&this.widget.close(),a&&a.list.length&&(b&&1==a.list.length?this.pick(a,0):this.widget=new e(this,a))},showWidget:function(b){this.data=b,this.widget=new e(this,b),a.signal(b,"shown")},buildOptions:function(a){var b=this.cm.options.hintOptions,c={},d;for(d in h)c[d]=h[d];if(b)for(d in b)void 0!==b[d]&&(c[d]=b[d]);if(a)for(d in a)void 0!==a[d]&&(c[d]=a[d]);return c}},e.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var a=this.completion.cm;this.completion.options.closeOnUnfocus&&(a.off("blur",this.onBlur),a.off("focus",this.onFocus)),a.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var a=this;this.keyMap={Enter:function(){a.picked=!0}},this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(b,c){b>=this.data.list.length?b=c?this.data.list.length-1:0:0>b&&(b=c?0:this.data.list.length-1);if(this.selectedHint!=b){var d=this.hints.childNodes[this.selectedHint];d.className=d.className.replace(" CodeMirror-hint-active",""),d=this.hints.childNodes[this.selectedHint=b],d.className+=" CodeMirror-hint-active",d.offsetTop<this.hints.scrollTop?this.hints.scrollTop=d.offsetTop-3:d.offsetTop+d.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=d.offsetTop+d.offsetHeight-this.hints.clientHeight+3),a.signal(this.data,"select",this.data.list[this.selectedHint],d)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}},a.registerHelper("hint","auto",function(b,c){var d=b.getHelpers(b.getCursor(),"hint");if(d.length)for(var e=0;e<d.length;e++){var f=d[e](b,c);if(f&&f.list.length)return f}else if(d=b.getHelper(b.getCursor(),"hintWords")){if(d)return a.hint.fromList(b,{words:d})}else if(a.hint.anyword)return a.hint.anyword(b,c)}),a.registerHelper("hint","fromList",function(b,c){for(var d=b.getCursor(),e=b.getTokenAt(d),f=[],g=0;g<c.words.length;g++){var h=c.words[g];h.slice(0,e.string.length)==e.string&&f.push(h)}if(f.length)return{list:f,from:a.Pos(d.line,e.start),to:a.Pos(d.line,e.end)}}),a.commands.autocomplete=a.showHint;var h={hint:a.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!1,container:null,customKeys:null,extraKeys:null};a.defineOption("hintOptions",null)})